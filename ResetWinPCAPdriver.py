# -*- coding: utf-8 -*-

'''
Reuben Brewer, Ph.D.
reuben.brewer@gmail.com
www.reubotics.com

Apache 2 License
Software Revision R, 02/27/2026

Verified working on: Python 3.11/12/13 for Windows 10, 11 64-bit.
'''

__author__ = 'reuben.brewer'

#########################################################
import os
import sys
import subprocess
import time
import traceback
import platform

from elevate import elevate #https://pypi.org/project/elevate/
#########################################################

##########################################################################################################
##########################################################################################################
##########################################################################################################
##########################################################################################################
##########################################################################################################
def ResetWinPCAPdriver():

    ##########################################################################################################
    ##########################################################################################################
    ##########################################################################################################
    ##########################################################################################################
    try:

        ##########################################################################################################
        ##########################################################################################################
        ##########################################################################################################
        if platform.system() == "Windows":

            ##########################################################################################################
            ##########################################################################################################
            try:
                elevate(show_console=True)
            ##########################################################################################################
            ##########################################################################################################

            ##########################################################################################################
            ##########################################################################################################
            except SystemExit as e:

                code = getattr(e, "code", 0) # elevate() commonly spawns an admin copy then sys.exit(0) in the original process.

                ########################################################################################################## Treat normal exits as "not an error" -> no traceback.
                if code in (0, None):
                    return 0
                ##########################################################################################################

                # Nonzero SystemExit is usually still a system/launch issue -> no traceback.
                print(f"@@@@@@@@@@@@@@@@@@ ResetWinPCAPdriver: Elevation failed (SystemExit code={code}) @@@@@@@@@@@@@@@@@@")
                time.sleep(2.0)

                return 0
            ##########################################################################################################
            ##########################################################################################################

            ##########################################################################################################
            ##########################################################################################################
            except OSError as e:

                # ShellExecute / OS-level launch failure -> no traceback.
                print(f"@@@@@@@@@@@@@@@@@@ ResetWinPCAPdriver: Elevation OS/system error: {e} @@@@@@@@@@@@@@@@@@")

                time.sleep(2.0)

                return 0
            ##########################################################################################################
            ##########################################################################################################

            ##########################################################################################################
            ##########################################################################################################
            print("@@@@@@@@@@@@@@@@@@@ Trying to ResetWinPCAPdriver @@@@@@@@@@@@@@@@@@@")

            subprocess.run("sc stop npf", shell=True)
            subprocess.run("sc start npf", shell=True)

            print("@@@@@@@@@@@@@@@@@@@ Success for ResetWinPCAPdriver @@@@@@@@@@@@@@@@@@@")

            time.sleep(2.0)

            return 1
            ##########################################################################################################
            ##########################################################################################################

        ##########################################################################################################
        ##########################################################################################################
        ##########################################################################################################

        ##########################################################################################################
        ##########################################################################################################
        ##########################################################################################################
        else:
            return 0
        ##########################################################################################################
        ##########################################################################################################
        ##########################################################################################################

    ##########################################################################################################
    ##########################################################################################################
    ##########################################################################################################
    ##########################################################################################################

    ##########################################################################################################
    ##########################################################################################################
    ##########################################################################################################
    ##########################################################################################################
    except (SystemExit, OSError) as e:

        # Catch any system-level exits that slip through later (no traceback).
        print(f"@@@@@@@@@@@@@@@@@@ ResetWinPCAPdriver: System-level exception: {e} @@@@@@@@@@@@@@@@@@@")
        time.sleep(2.0)

        return 0
    ##########################################################################################################
    ##########################################################################################################
    ##########################################################################################################
    ##########################################################################################################

    ##########################################################################################################
    ##########################################################################################################
    ##########################################################################################################
    ##########################################################################################################
    except Exception as e:
        # Only traceback for non-system problems (real code bugs).
        print("@@@@@@@@@@@@@@@@@@@ Failure for ResetWinPCAPdriver @@@@@@@@@@@@@@@@@@@, Exceptions: %s" % e)
        traceback.print_exc()
        time.sleep(5.0)

        return 0
    ##########################################################################################################
    ##########################################################################################################
    ##########################################################################################################
    ##########################################################################################################

##########################################################################################################
##########################################################################################################
##########################################################################################################
##########################################################################################################
##########################################################################################################

##########################################################################################################
##########################################################################################################
if __name__ == '__main__':
    ResetWinPCAPdriver()
##########################################################################################################
##########################################################################################################